services:

  api:
    image: ghcr.io/crimeisdown/trunk-transcribe:${VERSION:-main}
    build:
      context: .
      dockerfile: docker/Dockerfile
      cache_from:
        - ghcr.io/crimeisdown/trunk-transcribe:main
    ports:
      - ${API_PORT:-8000}:8000
    command: api
    volumes:
      - ./app:/src/app
      - ./config:/src/config
      - ./tests:/src/tests
      - ./docker/docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh
      - ./docker/healthcheck.sh:/usr/local/bin/healthcheck.sh
    env_file: .env
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8000/healthz"]
      retries: 3
      timeout: 5s
    labels:
      - autoheal=true

  chat-ui:
    image: ghcr.io/crimeisdown/trunk-transcribe:${VERSION:-main}
    build:
      context: .
      dockerfile: docker/Dockerfile
      cache_from:
        - ghcr.io/crimeisdown/trunk-transcribe:main
    command: chat-ui
    volumes:
      - ./app:/src/app
      - ./config:/src/config
      - ./docker/docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh
    env_file: .env
    environment:
      - CHAT_UI_HOST=0.0.0.0
      - CHAT_UI_BIND_PORT=7932
    ports:
      - ${CHAT_UI_PORT:-7932}:7932
    depends_on:
      meilisearch:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "uv",
          "run",
          "python",
          "-c",
          "import socket,sys; s=socket.socket(); s.settimeout(5); rc=s.connect_ex(('127.0.0.1',7932)); s.close(); sys.exit(0 if rc == 0 else 1)",
        ]
      retries: 3
      timeout: 5s
    restart: always

  flower:
    image: ghcr.io/crimeisdown/trunk-transcribe:${VERSION:-main}
    command: flower
    volumes:
      - ./docker/docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh
      - flower-data:/src/data
    ports:
      - ${FLOWER_PORT:-5555}:5555
    environment:
      - CELERY_BROKER_URL
      - CELERY_RESULT_BACKEND
      - CELERY_QUEUES=transcribe,transcribe_gpu,post_transcribe
      - FLOWER_PURGE_OFFLINE_WORKERS=120
      - FLOWER_PERSISTENT=1
      - FLOWER_DB=/src/data/flower
      - FLOWER_STATE_SAVE_INTERVAL=30000
      - FLOWER_BROKER_API
    restart: always

  rabbitmq:
    image: rabbitmq:3-management
    hostname: "rabbitmq"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - ./docker/rabbitmq-timeout.conf:/etc/rabbitmq/conf.d/30-timeout.conf
    ports:
      - ${RABBITMQ_PORT:-5672}:5672
      - ${RABBITMQ_MGMT_PORT:-15672}:15672
    environment:
      - RABBITMQ_DEFAULT_USER
      - RABBITMQ_DEFAULT_PASS
    restart: always

  typesense:
    image: typesense/typesense:${TYPESENSE_VERSION:-27.1}
    ports:
      - ${TYPESENSE_PORT:-8108}:8108
    environment:
      - TYPESENSE_DATA_DIR=/data
      - TYPESENSE_API_KEY
      - TYPESENSE_ENABLE_CORS
      - TYPESENSE_CORS_DOMAINS
    volumes:
      - typesense-data:/data
    # healthcheck:
    #   test: ["CMD", "curl", "-f",  "http://localhost:8108/health"]
    #   retries: 3
    #   timeout: 5s
    restart: always
    labels:
      - autoheal=true

  meilisearch:
    image: 'getmeili/meilisearch:${MEILI_VERSION:-latest}'
    ports:
      - ${MEILI_PORT:-7700}:7700
    environment:
      - MEILI_MASTER_KEY
    volumes:
      - meilisearch-data:/meili_data
    healthcheck:
      test: ["CMD", "curl", "-f",  "http://localhost:7700/health"]
      retries: 3
      timeout: 5s
    restart: always
    labels:
      - autoheal=true

  postgres:
    image: postgres:${POSTGRES_VERSION:-latest}
    ports:
      - ${POSTGRES_PORT:-5432}:5432
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
    volumes:
      - postgres-data:/var/lib/postgresql
    restart: always

  frontend:
    build:
      context: frontend
      dockerfile: Dockerfile
    ports:
      - ${FRONTEND_PORT:-3000}:3000
    environment:
      - MEILI_URL
      - MEILI_MASTER_KEY
      - MEILI_INDEX
      - API_KEY
      - WEBSOCKET_URL=ws://localhost:${API_PORT:-8000}/ws

volumes:
  flower-data:
  rabbitmq-data:
  meilisearch-data:
  typesense-data:
  postgres-data:
